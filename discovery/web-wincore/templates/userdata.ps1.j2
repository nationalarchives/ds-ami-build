<powershell>
Set-ExecutionPolicy -ExecutionPolicy bypass -Force

ni C:\textfile.txt

"[debug]" | Out-File -FilePath C:\debug.txt
"set password and add user" | Out-File -FilePath C:\debug.txt -Append
# create ansible winrm admin user
$password = "{{ password }}" | ConvertTo-SecureString -AsPlainText -Force
$newUserParams = @{
        Name                 = "ansible-winrm"
        AccountNeverExpires  = $true
        PasswordNeverExpires = $true
        Password             = "pc_ij_may24Aspaces"
    }
$null = New-LocalUser @newUserParams
Add-LocalGroupMember -Group "Administrators" -Member "ansible-winrm"
Add-LocalGroupMember -Group "Remote Desktop Users" -Member "ansible-winrm"

winrm set winrm/config/client/auth @{Basic="true"}
winrm set winrm/config/service/auth @{Basic="true"}
winrm set winrm/config/service @{AllowUnencrypted="true"}

"port opening" | Out-File -FilePath C:\debug.txt -Append
"port 22" | Out-File -FilePath C:\debug -Append
New-NetFirewallRule -DisplayName "sshd" -Direction Inbound -LocalPort 22 -Protocol TCP -Action Allow
"port 3389" | Out-File -FilePath C:\debug.txt -Append
New-NetFirewallRule -DisplayName "rdp" -Direction Inbound -LocalPort 3389 -Protocol TCP -Action Allow
"port 5985" | Out-File -FilePath C:\debug.txt -Append
# open firewall for WinRM
New-NetFirewallRule -DisplayName "Allow WinRM Port 5985" -Direction Inbound -LocalPort 5985 -Protocol TCP -Action Allow
"port 5986" | Out-File -FilePath C:\debug -Append
New-NetFirewallRule -DisplayName "Allow WinRM Port 5986" -Direction Inbound -LocalPort 5986 -Protocol TCP -Action Allow

"ansible script" | Out-File -FilePath C:\debug.txt -Append
# from powershell:
Invoke-Expression ((New-Object System.Net.Webclient).DownloadString('https://raw.githubusercontent.com/ansible/ansible/devel/examples/scripts/ConfigureRemotingForAnsible.ps1'))

"allow remote desktop" | Out-File -FilePath C:\debug.txt -Append
"set fDenyTSConnections" | Out-File -FilePath C:\debug.txt -Append
# allow remote desktop
Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\" -Name "fDenyTSConnections" -Value $false
"set UserAuthentication" | Out-File -FilePath C:\debug.txt -Append
Set-ItemProperty ‘HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp\‘ -Name “UserAuthentication” -Value $true
"enable Remote Desktop" | Out-File -FilePath C:\debug.txt -Append
Enable-NetFirewallRule -DisplayGroup “Remote Desktop”

# allow remote management
"enable PSRemoting" | Out-File -FilePath C:\debug.txt -Append
Enable-PSRemoting -SkipNetworkProfileCheck -Force
"enable Windows Management Instrumentation (DCOM-In)" | Out-File -FilePath C:\debug.txt -Append
Enable-NetFirewallRule -DisplayName "Windows Management Instrumentation (DCOM-In)"
"enable Remote Event Log Management" | Out-File -FilePath C:\debug.txt -Append
Enable-NetFirewallRule -DisplayGroup "Remote Event Log Management"
"enable Remote Service Management" | Out-File -FilePath C:\debug.txt -Append
Enable-NetFirewallRule -DisplayGroup "Remote Service Management"
"enable Remote Volume Management" | Out-File -FilePath C:\debug.txt -Append
Enable-NetFirewallRule -DisplayGroup "Remote Volume Management"
#"enable Windows Firewall Remote Management" | Out-File -FilePath C:\debug.txt -Append
#Enable-NetFirewallRule -DisplayGroup "Windows Firewall Remote Management"
"enable Remote Event Log Management" | Out-File -FilePath C:\debug.txt -Append
Enable-NetFirewallRule -DisplayGroup "Remote Event Log Management"
"enable Remote Scheduled Tasks Management" | Out-File -FilePath C:\debug.txt -Append
Enable-NetFirewallRule -DisplayGroup "Remote Scheduled Tasks Management"

"set WSMan" | Out-File -FilePath C:\debug.txt -Append
Set-Item -Path "WSMan:\localhost\Service\AllowUnencrypted" -Value $true
#Set-Item -Path WSMan:\localhost\Service\Auth\Certificate -Value $true
Set-Item -Path WSMan:\localhost\Service\Auth\Basic -Value $true
#Set-Item -Path WSMan:\localhost\Service\Auth\CredSSP -Value $true

"open firewall for ssh" | Out-File -FilePath C:\debug.txt -Append
if (!(Get-NetFirewallRule -Name "OpenSSH-Server-In-TCP" -ErrorAction SilentlyContinue | Select-Object Name, Enabled)) {
    New-NetFirewallRule -Name 'OpenSSH-Server-In-TCP' -DisplayName 'OpenSSH Server (sshd)' -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort 22
}

"install openssh" | Out-File -FilePath C:\debug.txt -Append
#start ssh server service and open port
Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
"start sshd" | Out-File -FilePath C:\debug.txt -Append
Start-Service sshd

"[status]" | Out-File -FilePath C:\finish-init.txt
"finished = true" | Out-File -FilePath C:\finish-init.txt -Append
</powershell>
<persist>true</persist>
