<powershell>
Set-ExecutionPolicy -ExecutionPolicy bypass -Force

Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "DenyTSConnections" -Value 0 -PropertyType DWORD -Force | Out-Null

# open firewall for WinRM
Set-NetFirewallRule -DisplayGroup "Windows Firewall Remote Management" -Enabled True -Action Allow
#New-NetFirewallRule -DisplayName "Allow SSH Port 22" -Direction Inbound -LocalPort 22 -Protocol TCP -Action Allow
New-NetFirewallRule -DisplayName "Allow RDP Port 3389" -Direction Inbound -LocalPort 3389 -Protocol TCP -Action Allow
New-NetFirewallRule -DisplayName "Allow WinRM Port 5985" -Direction Inbound -LocalPort 5985 -Protocol TCP -Action Allow
New-NetFirewallRule -DisplayName "Allow WinRM Port 5986" -Direction Inbound -LocalPort 5986 -Protocol TCP -Action Allow

Enable-PSRemoting -SkipNetworkProfileCheck -Force
Set-Item -Path "WSMan:\localhost\Service\AllowUnencrypted" -Value $false
Set-Item -Path WSMan:\localhost\Service\Auth\Certificate -Value $true
Set-Item -Path WSMan:\localhost\Service\Auth\CredSSP -Value $true

# from powershell:
Invoke-Expression ((New-Object System.Net.Webclient).DownloadString('https://raw.githubusercontent.com/ansible/ansible/devel/examples/scripts/ConfigureRemotingForAnsible.ps1'))

$password = "{{ password }}" | ConvertTo-SecureString -AsPlainText -Force
$newUserParams = @{
        Name                 = "ansible-winrm"
        AccountNeverExpires  = $true
        PasswordNeverExpires = $true
        Password             = $password
    }
$null = New-LocalUser @newUserParams
Add-LocalGroupMember -Group "Administrators" -Member "ansible-winrm"

"[status]" | Out-File -FilePath /finish-init.txt
"finished = true" | Out-File -FilePath /finish-init.txt -Append
</powershell>
<persist>true</persist>
