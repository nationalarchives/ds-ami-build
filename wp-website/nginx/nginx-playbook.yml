# NginX playbook
---

- name: create NginX Reverse Proxy Primer
  hosts: localhost
  gather_facts: false

  tasks:
  - name: load variables
    ansible.builtin.include_vars:
      file: "{{ ansible_var_file }}"

  - name: get AWS session token
    community.aws.sts_session_token:
      duration_seconds: 3600
    register: session_credentials

  - name: switch role credentials
    community.aws.sts_assume_role:
      aws_access_key: "{{ session_credentials.sts_creds.access_key }}"
      aws_secret_key: "{{ session_credentials.sts_creds.secret_key }}"
      security_token: "{{ session_credentials.sts_creds.session_token }}"
      role_arn: "{{ lookup ('env', 'AWS_ROLE_ARN') }}"
      role_session_name: "s-devops"
    register: assumed_role

  - name: show role switch
    ansible.builtin.debug:
     msg:
      - "role changed  {{ assumed_role.changed }}"
      - "role arn: {{ lookup ('env', 'AWS_ROLE_ARN') }}"

  - import_tasks: prepare-instance.yml

- name: on ec2host
- hosts: ec2hosts
  gather_facts: false
  tasks:
  - import_tasks: prepare-instance.yml

- name: switch to localhost
  hosts: localhost
  gather_facts: true

  tasks:
  - import_tasks: create-ami.yml
  - import_tasks: clean-up.yml
