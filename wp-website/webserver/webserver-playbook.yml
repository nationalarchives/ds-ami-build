# WordPress webserver playbook
---

- name: create WordPress webserver AMI
  hosts: localhost
  gather_facts: false

  tasks:

  - name: load variables
    ansible.builtin.include_vars:
      file: "{{ ansible_var_file }}"

  - name: get AWS session token
    community.aws.sts_session_token:
      duration_seconds: 3600
    register: session_credentials

  - name: switch role credentials
    community.aws.sts_assume_role:
      aws_access_key: "{{ session_credentials.sts_creds.access_key }}"
      aws_secret_key: "{{ session_credentials.sts_creds.secret_key }}"
      security_token: "{{ session_credentials.sts_creds.session_token }}"
      role_arn: "{{ lookup ('env', 'AWS_ROLE_ARN') }}"
      role_session_name: "s-devops"
    register: assumed_role

  - name: show role switch
    ansible.builtin.debug:
     msg:
      - "role changed  {{ assumed_role.changed }}"
      - "role arn: {{ lookup ('env', 'AWS_ROLE_ARN') }}"

  - name: get linux2 AMI
    amazon.aws.ec2_ami_info:
      aws_access_key: "{{ assumed_role.sts_creds.access_key }}"
      aws_secret_key: "{{ assumed_role.sts_creds.secret_key }}"
      security_token: "{{ assumed_role.sts_creds.session_token }}"
      owners: amazon
      region: "{{ region }}"
      filters:
        name: "amzn2-ami-hvm*"
    register: findami

  - name: set latest AMI
    set_fact:
      latest_ami: >
        {{ findami.images | sort(attribute='creation_date') | last }}

  - name: read secrets from aws secrets manager
    debug:
      msg:
        - "values: {{ lookup('amazon.aws.aws_secret', 'dev/WordPress', region=region, aws_access_key=assumed_role.sts_creds.access_key, aws_secret_key=assumed_role.sts_creds.secret_key, aws_security_token=assumed_role.sts_creds.session_token, on_denied='warn') | from_json }}"

  - name: set secret values
    vars:
      secret_data: "{{ lookup('amazon.aws.aws_secret', 'dev/WordPress', region=region, aws_access_key=assumed_role.sts_creds.access_key, aws_secret_key=assumed_role.sts_creds.secret_key, aws_security_token=assumed_role.sts_creds.session_token, on_denied='warn') | from_json }}"

  - set_fact:
      github_token: "{{ secret_data.github_token }}"

  - name: secret output
    debug:
      msg:
        - "{{ github_token }}"

